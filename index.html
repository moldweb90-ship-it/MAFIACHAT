<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Chat Widget - Flower Mafia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Telegram Custom Scrollbar */
        .tg-scrollbar::-webkit-scrollbar { width: 4px; }
        .tg-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .tg-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.15); border-radius: 4px; }
        .tg-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.25); }

        /* Background Pattern */
        .tg-bg {
            background-color: #E6EBEF;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%236c8ea0' fill-opacity='0.12' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Message Bubbles */
        .message-in::before {
            content: ""; position: absolute; left: -6px; bottom: 6px; width: 10px; height: 10px;
            background: white; border-bottom-right-radius: 10px;
            clip-path: polygon(100% 0, 100% 100%, 0 100%);
        }
        .message-out::before {
            content: ""; position: absolute; right: -6px; bottom: 6px; width: 10px; height: 10px;
            background: #EEFFDE; border-bottom-left-radius: 10px;
            clip-path: polygon(0 0, 0% 100%, 100% 100%);
        }

        /* Animations */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }
        .widget-animate { animation: slideInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .pop-in { animation: popIn 0.3s ease-out forwards; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Typing Dots */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Hide scrollbar for chips */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth Scroll behavior */
        .scroll-smooth { scroll-behavior: smooth; }

        /* Input specific */
        .chat-input-wrapper {
             transition: all 0.2s ease-in-out;
        }
        .chat-input-wrapper:focus-within {
            background-color: white;
            box-shadow: 0 0 0 2px rgba(42, 171, 238, 0.2);
            border-color: rgba(42, 171, 238, 0.4);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            #chat-window {
                width: calc(100vw - 32px) !important;
                max-width: 400px !important;
                height: 70vh !important;
                max-height: 600px !important;
                min-height: 400px !important;
                border-radius: 20px !important;
                bottom: 80px !important;
                right: 16px !important;
                top: auto !important;
                left: auto !important;
                position: fixed !important;
            }
            
            #telegram-widget-container {
                bottom: 0 !important;
                right: 0 !important;
                width: auto !important;
                height: auto !important;
            }
            
            #widget-trigger {
                width: 56px !important;
                height: 56px !important;
                bottom: 16px !important;
                right: 16px !important;
                position: fixed !important;
            }
            
            #welcome-bubble {
                bottom: 70px !important;
                right: 16px !important;
                max-width: calc(100vw - 32px) !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen font-sans">

    <!-- Audio assets -->
    <audio id="notify-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
    <audio id="sent-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>

    <!-- WIDGET CONTAINER -->
    <div id="telegram-widget-container" class="fixed bottom-0 right-0 md:bottom-6 md:right-6 z-[9999] flex flex-col items-end gap-3 font-sans antialiased pointer-events-none">

        <!-- Welcome Bubble -->
        <div id="welcome-bubble" class="hidden pointer-events-auto bg-white p-3 md:p-4 rounded-xl md:rounded-2xl shadow-xl mb-1 mr-4 md:mr-0 max-w-[280px] md:max-w-[290px] relative transform transition-all duration-300 origin-bottom-right border border-gray-100 hover:scale-105 cursor-pointer hover:shadow-2xl z-[10000]" onclick="toggleChat()" style="position: fixed; bottom: 80px; right: 16px;">
            <div class="flex gap-3 items-center">
                <div class="relative w-12 h-12 rounded-full shrink-0">
                     <img src="https://raw.githubusercontent.com/moldweb90-ship-it/MAFIACHAT/main/public/Eiva.jpg" class="w-full h-full object-cover rounded-full border border-gray-100" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3E–§–æ—Ç–æ%3C/text%3E%3C/svg%3E'">
                     <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full animate-ping absolute inline-flex opacity-75"></span>
                     <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full relative inline-flex"></span>
                </div>
                <div>
                    <p class="text-[14px] md:text-[15px] font-bold text-gray-800 leading-tight">–§–ª–æ—Ä–∏—Å—Ç –ê–Ω–Ω–∞</p>
                    <p id="bubble-text" class="text-[12px] md:text-[13px] text-gray-600 leading-snug mt-0.5">
                        –Ø –æ–Ω–ª–∞–π–Ω! üëã<br>–°–¥–µ–ª–∞–µ–º —Å–∫–∏–¥–∫—É –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑?
                    </p>
                </div>
            </div>
            <button onclick="closeWelcome(event)" class="absolute -top-2 -right-2 bg-white hover:bg-gray-100 text-gray-400 hover:text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md transition border border-gray-100">‚úï</button>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="pointer-events-auto hidden bg-white w-full h-full md:w-[380px] md:h-[620px] md:max-h-[85vh] md:rounded-2xl shadow-2xl flex flex-col overflow-hidden widget-animate border border-gray-200/50 fixed bottom-0 right-0 md:relative md:bottom-auto md:right-auto">
            
            <!-- Header -->
            <div class="bg-[#2AABEE] text-white p-2.5 px-3 md:p-3 md:px-4 flex items-center justify-between shrink-0 shadow-sm z-20">
                <div class="flex items-center gap-2 md:gap-3 cursor-pointer hover:opacity-90 transition group" onclick="openTelegramLink()">
                    <div class="relative">
                        <div class="w-9 h-9 md:w-10 md:h-10 bg-white rounded-full flex items-center justify-center overflow-hidden border-2 border-white/20 group-hover:border-white/40 transition">
                           <img src="https://raw.githubusercontent.com/moldweb90-ship-it/MAFIACHAT/main/public/Eiva.jpg" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3E–§–æ—Ç–æ%3C/text%3E%3C/svg%3E'">
                        </div>
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 md:w-3 md:h-3 bg-[#00E096] border-2 border-[#2AABEE] rounded-full"></span>
                    </div>
                    <div class="flex flex-col">
                        <span class="font-bold text-[14px] md:text-[16px] leading-tight tracking-wide">–¶–≤–µ—Ç–æ—á–Ω–∞—è –ú–∞—Ñ–∏—è</span>
                        <span id="status-text" class="text-[11px] md:text-[13px] text-blue-50 opacity-90 font-medium transition-all duration-300">–≤ —Å–µ—Ç–∏</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-1.5 md:gap-2">
                    <!-- CALL OPERATOR BUTTON (Default) -->
                    <button onclick="handleManualOperatorCall()" class="flex items-center gap-1 bg-white/20 hover:bg-white/30 px-2 py-1 md:px-3 md:py-1.5 rounded-full text-[10px] md:text-[12px] font-bold transition backdrop-blur-sm border border-white/10 group shadow-sm">
                         <span class="relative flex h-1.5 w-1.5 md:h-2 md:w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-full w-full bg-white"></span>
                         </span>
                         <span class="hidden sm:inline">–û–ø–µ—Ä–∞—Ç–æ—Ä</span>
                         <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sm:hidden"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                    </button>

                    <!-- Close -->
                    <button onclick="toggleChat()" class="p-1 md:p-1.5 hover:bg-white/10 rounded-full transition text-white/80 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="md:w-6 md:h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>

            <!-- Intro Screen (Name Input) -->
            <div id="intro-screen" class="hidden absolute inset-0 bg-[#E6EBEF] z-30 flex flex-col items-center justify-center p-4 md:p-6 text-center fade-in" style="top: 50px;">
                <div class="bg-white p-4 md:p-6 rounded-xl md:rounded-2xl shadow-lg w-full max-w-xs relative overflow-hidden">
                    <div class="w-12 h-12 md:w-16 md:h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4 text-2xl md:text-3xl">üëã</div>
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-1.5 md:mb-2">–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!</h3>
                    <p class="text-gray-500 text-xs md:text-sm mb-3 md:mb-4">–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</p>
                    
                    <input type="text" id="username-input" class="w-full bg-gray-50 border border-gray-200 rounded-lg md:rounded-xl px-3 md:px-4 py-2.5 md:py-3 mb-2.5 md:mb-3 focus:outline-none focus:ring-2 focus:ring-[#2AABEE] text-center text-sm md:text-base" placeholder="–í–∞—à–µ –∏–º—è">
                    
                    <button onclick="saveNameAndStart()" class="w-full bg-[#2AABEE] hover:bg-[#229ED9] text-white font-bold py-2.5 md:py-3 rounded-lg md:rounded-xl transition transform active:scale-95 text-sm md:text-base">
                        –ù–∞—á–∞—Ç—å —á–∞—Ç
                    </button>
                    <button onclick="skipName()" class="mt-2 md:mt-3 text-[10px] md:text-xs text-gray-400 hover:text-gray-600 underline">–ü—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <!-- Main Chat Interface -->
            <div id="chat-interface" class="flex-1 flex flex-col h-full overflow-hidden">
                
                <!-- Messages Area -->
                <div id="messages-area" class="flex-1 tg-bg p-2 md:p-4 overflow-y-auto tg-scrollbar flex flex-col gap-2 md:gap-3 relative pb-2">
                    <!-- Messages go here -->
                </div>

                <!-- Chips (Quick Replies) with Navigation Arrows -->
                <div class="bg-white/95 backdrop-blur border-t border-gray-100 py-2 md:py-2.5 z-20 shrink-0 relative group/chips">
                    
                    <!-- Left Arrow -->
                    <button onclick="scrollChips('left')" class="hidden md:flex absolute left-0 top-0 bottom-0 w-8 items-center justify-center bg-gradient-to-r from-white via-white to-transparent z-10 text-gray-400 hover:text-[#2AABEE] transition opacity-0 group-hover/chips:opacity-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>

                    <!-- Chips Container -->
                    <div id="chips-container" class="flex gap-1.5 md:gap-2 overflow-x-auto no-scrollbar whitespace-nowrap px-3 md:px-4 scroll-smooth">
                        <button onclick="sendChip('–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –¥–æ—Å—Ç–∞–≤–∫–∞? üöö')" class="shrink-0 px-2.5 py-1 md:px-3 md:py-1.5 bg-white border border-[#2AABEE]/20 text-[#2AABEE] text-[11px] md:text-[13px] font-semibold rounded-lg md:rounded-xl hover:bg-[#2AABEE] hover:text-white transition-all shadow-sm active:scale-95 select-none">
                            üöö –î–æ—Å—Ç–∞–≤–∫–∞
                        </button>
                         <button onclick="sendChip('–°–∫–∏–¥–∫–∞ –Ω–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑ üî•')" class="shrink-0 px-2.5 py-1 md:px-3 md:py-1.5 bg-white border border-[#2AABEE]/20 text-[#2AABEE] text-[11px] md:text-[13px] font-semibold rounded-lg md:rounded-xl hover:bg-[#2AABEE] hover:text-white transition-all shadow-sm active:scale-95 select-none">
                            üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑
                        </button>
                        <button onclick="sendChip('–¶–µ–Ω—ã –Ω–∞ —Ü–≤–µ—Ç—ã üí∏')" class="shrink-0 px-2.5 py-1 md:px-3 md:py-1.5 bg-white border border-[#2AABEE]/20 text-[#2AABEE] text-[11px] md:text-[13px] font-semibold rounded-lg md:rounded-xl hover:bg-[#2AABEE] hover:text-white transition-all shadow-sm active:scale-95 select-none">
                            üí∏ –¶–µ–Ω—ã
                        </button>
                         <button onclick="sendChip('–ó–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é/—Å—Ç–∏—Ö üéµ')" class="shrink-0 px-2.5 py-1 md:px-3 md:py-1.5 bg-white border border-[#2AABEE]/20 text-[#2AABEE] text-[11px] md:text-[13px] font-semibold rounded-lg md:rounded-xl hover:bg-[#2AABEE] hover:text-white transition-all shadow-sm active:scale-95 select-none">
                            üéµ –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è
                        </button>
                        <button onclick="sendChip('–ì–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å? üìç')" class="shrink-0 px-2.5 py-1 md:px-3 md:py-1.5 bg-white border border-[#2AABEE]/20 text-[#2AABEE] text-[11px] md:text-[13px] font-semibold rounded-lg md:rounded-xl hover:bg-[#2AABEE] hover:text-white transition-all shadow-sm active:scale-95 select-none">
                            üìç –ê–¥—Ä–µ—Å
                        </button>
                    </div>

                    <!-- Right Arrow -->
                    <button onclick="scrollChips('right')" class="hidden md:flex absolute right-0 top-0 bottom-0 w-8 items-center justify-center bg-gradient-to-l from-white via-white to-transparent z-10 text-gray-400 hover:text-[#2AABEE] transition opacity-0 group-hover/chips:opacity-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>

                <!-- Input Area (Refined Compact) -->
                <div class="bg-white px-2 py-1.5 md:px-3 md:py-2 flex items-end gap-1.5 md:gap-2 z-20 pb-2 md:pb-3 border-t border-gray-50 safe-area-inset-bottom">
                    <!-- Paperclip Icon -->
                    <button onclick="openTelegramLink()" class="w-7 h-8 md:w-8 md:h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 transition shrink-0" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å (–≤ Telegram)">
                         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="md:w-[22px] md:h-[22px]"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                    </button>

                    <div class="flex-1 bg-gray-100 rounded-[1rem] md:rounded-[1.2rem] flex items-center px-3 md:px-4 py-1.5 md:py-2 min-h-[36px] md:min-h-[40px] chat-input-wrapper border border-transparent">
                        <textarea id="chat-input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="w-full bg-transparent border-none focus:ring-0 outline-none text-gray-800 text-[14px] md:text-[15px] resize-none overflow-hidden py-0.5 md:py-1 leading-relaxed placeholder-gray-400" style="max-height: 100px;"></textarea>
                    </div>
                    
                    <button id="send-btn" onclick="handleUserSend()" class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center bg-[#2AABEE] text-white rounded-full transition transform hover:scale-105 active:scale-95 hover:bg-[#229ED9] shadow-sm shrink-0">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" class="fill-current ml-0.5 mt-0.5 md:w-5 md:h-5"><path d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685z"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Button -->
        <button id="widget-trigger" onclick="toggleChat()" class="pointer-events-auto group w-14 h-14 md:w-16 md:h-16 bg-[#2AABEE] rounded-full flex items-center justify-center shadow-[0_4px_14px_rgba(42,171,238,0.4)] hover:shadow-[0_8px_24px_rgba(42,171,238,0.5)] hover:bg-[#229ED9] transition-all duration-300 transform hover:scale-105 z-50 fixed bottom-4 right-4 md:relative md:bottom-auto md:right-auto md:mr-0 md:mb-0">
            <svg id="icon-closed" class="w-6 h-6 md:w-8 md:h-8 text-white fill-current transition-transform duration-300 transform group-hover:-rotate-12 translate-x-[-1px] translate-y-[1px]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.946 9.315c-.522-.174-.527-.455.01-.634l19.087-6.362c.529-.176.832.12.684.638l-5.454 19.086c-.15.529-.455.547-.679.045L12 14l6-8-8 6-8.054-2.685z"></path></svg>
            <svg id="icon-opened" class="w-6 h-6 md:w-7 md:h-7 text-white hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span id="notification-badge" class="hidden absolute -top-1 -right-1 flex h-5 w-5 md:h-6 md:w-6 z-50">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                <span id="badge-count" class="relative inline-flex rounded-full h-full w-full bg-red-500 text-white text-[10px] md:text-[11px] items-center justify-center font-bold border-2 border-white shadow-sm">1</span>
            </span>
        </button>

    </div>

    <script>
        /* --- CONFIGURATION --- */
        const TELEGRAM_USERNAME = 'FlowersMafia_help_bot'; 
        const WELCOME_DELAY = 10000; 
        const BUBBLE_DELAY = 3000; 

        /* --- STATE --- */
        let isOpen = false;
        let messages = []; 
        let unreadCount = 0;
        let hasOpenedOnce = false;
        let userName = localStorage.getItem('chat_username') || '';
        let lastBotResponse = ""; // To prevent loops
        let contextMemory = ""; // To remember dates/details

        /* --- DOM ELEMENTS --- */
        const els = {
            window: document.getElementById('chat-window'),
            intro: document.getElementById('intro-screen'),
            chatUI: document.getElementById('chat-interface'),
            usernameInput: document.getElementById('username-input'),
            trigger: document.getElementById('widget-trigger'),
            iconClosed: document.getElementById('icon-closed'),
            iconOpened: document.getElementById('icon-opened'),
            welcome: document.getElementById('welcome-bubble'),
            bubbleText: document.getElementById('bubble-text'),
            badge: document.getElementById('notification-badge'),
            badgeCount: document.getElementById('badge-count'),
            area: document.getElementById('messages-area'),
            input: document.getElementById('chat-input'),
            status: document.getElementById('status-text'),
            chips: document.getElementById('chips-container'),
            audioIn: document.getElementById('notify-sound'),
            audioOut: document.getElementById('sent-sound')
        };

        /* --- KNOWLEDGE BASE (THE BRAIN) --- */
        const knowledgeBase = [
            {
                // –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–º–∏!
                keywords: ['–∑–¥—Ä–∞–≤—Å—Ç–≤', '–ø—Ä–∏–≤–µ—Ç', '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å', '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ', '–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä', '–¥–æ–±—Ä–æ–π –Ω–æ—á–∏', '–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏', 'hi', 'hello', 'hey', '–¥–æ–±—Ä', '–ø—Ä–∏–≤'],
                answer: () => {
                    const greeting = getGreetingText();
                    const variants = [
                        `${greeting}! üëã<br>–Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–ª–æ—Ä–∏—Å—Ç –∏–∑ –¶–≤–µ—Ç–æ—á–Ω–æ–π –ú–∞—Ñ–∏–∏. –†–∞–¥–∞ –ø–æ–º–æ—á—å!<br><br>–ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞?<br>‚Ä¢ üí∏ –£–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã –Ω–∞ –±—É–∫–µ—Ç—ã<br>‚Ä¢ üöö –£—Ç–æ—á–Ω–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É<br>‚Ä¢ üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑ —Å–æ —Å–∫–∏–¥–∫–æ–π<br>‚Ä¢ üìç –ê–¥—Ä–µ—Å–∞ –Ω–∞—à–∏—Ö —Å–∞–ª–æ–Ω–æ–≤<br>‚Ä¢ üéµ –ó–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é/—Å—Ç–∏—Ö –∫ –±—É–∫–µ—Ç—É<br><br>–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç! üòä`,
                        `${greeting}! üëã<br>–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —è —Ñ–ª–æ—Ä–∏—Å—Ç –∏–∑ –¶–≤–µ—Ç–æ—á–Ω–æ–π –ú–∞—Ñ–∏–∏. –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å —Å –≤—ã–±–æ—Ä–æ–º –±—É–∫–µ—Ç–∞!<br><br>–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?<br>‚Ä¢ üí∏ –¶–µ–Ω—ã –Ω–∞ –±—É–∫–µ—Ç—ã<br>‚Ä¢ üöö –î–æ—Å—Ç–∞–≤–∫–∞<br>‚Ä¢ üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑ (—Å–∫–∏–¥–∫–∞ 600‚ÇΩ)<br>‚Ä¢ üìç –ì–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è<br>‚Ä¢ üéµ –ü–µ—Å–Ω–∏ –∏ —Å—Ç–∏—Ö–∏ –∫ –±—É–∫–µ—Ç—É<br><br>–ü–∏—à–∏—Ç–µ, –æ—Ç–≤–µ—á—É –±—ã—Å—Ç—Ä–æ! üòä`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['—Ü–µ–Ω—ã', '—Ü–µ–Ω–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç', '–ø–æ—á–µ–º', '–ø—Ä–∞–π—Å', '—Å—Ç–æ–∏—Ç', '–¥–µ—à–µ–≤–æ', '–¥–æ—Ä–æ–≥–æ', '–±—é–¥–∂–µ—Ç'],
                answer: () => {
                    const variants = [
                        `–¶–µ–Ω—ã –Ω–∞ –±—É–∫–µ—Ç—ã —É –Ω–∞—Å —Ä–∞–∑–Ω—ã–µ –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–æ—Å—Ç–∞–≤–∞, —Ä–∞–∑–º–µ—Ä–∞ –∏ —Å–µ–∑–æ–Ω–∞! üíê<br>–ï—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç 1000‚ÇΩ –¥–æ –ø—Ä–µ–º–∏—É–º-–±—É–∫–µ—Ç–æ–≤. –¢–æ—á–Ω—É—é —Ü–µ–Ω—É –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏—Ç—å —É —Ñ–ª–æ—Ä–∏—Å—Ç–∞ –≤ —Å–∞–ª–æ–Ω–µ ‚Äî –æ–Ω –ø–æ–¥–±–µ—Ä–µ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç –∏ –ø–æ–≤–æ–¥.<br><br>–•–æ—Ç–∏—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º? –û–Ω –ø–æ–∫–∞–∂–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±—É–∫–µ—Ç—ã –∏ –Ω–∞–∑–æ–≤–µ—Ç —Ç–æ—á–Ω—ã–µ —Ü–µ–Ω—ã! üëá<br><button onclick="openTelegramLink()" class="w-full bg-[#FF7EB3] text-white font-bold py-2.5 rounded-xl hover:bg-[#FF65A3] transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.56 8.35l-1.99 9.38c-.15.68-.56.84-1.13.52l-3.14-2.31-1.52 1.46c-.17.17-.31.31-.63.31l.22-3.19 5.81-5.25c.25-.22-.06-.35-.39-.12l-7.18 4.52-3.09-.97c-.67-.21-.68-.67.14-.99l12.08-4.66c.56-.21 1.05.13.82 1.3z"/></svg>
                        –ù–∞–ø–∏—Å–∞—Ç—å —Ñ–ª–æ—Ä–∏—Å—Ç—É
                    </button>`,
                        `–¶–µ–Ω—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–æ—Å—Ç–∞–≤–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞ –±—É–∫–µ—Ç–∞! üíê<br>–£ –Ω–∞—Å –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç 1000‚ÇΩ –¥–æ –ø—Ä–µ–º–∏—É–º-–∫–æ–º–ø–æ–∑–∏—Ü–∏–π. –ß—Ç–æ–±—ã –Ω–∞–∑–≤–∞—Ç—å —Ç–æ—á–Ω—É—é —Ü–µ–Ω—É, –ª—É—á—à–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º ‚Äî –æ–Ω –ø–æ–∫–∞–∂–µ—Ç —Å–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã –∏ –ø–æ–¥–±–µ—Ä–µ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.<br><br>–°–≤—è–∑–∞—Ç—å—Å—è —Å —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º? üëá<br><button onclick="openTelegramLink()" class="w-full bg-[#FF7EB3] text-white font-bold py-2.5 rounded-xl hover:bg-[#FF65A3] transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.56 8.35l-1.99 9.38c-.15.68-.56.84-1.13.52l-3.14-2.31-1.52 1.46c-.17.17-.31.31-.63.31l.22-3.19 5.81-5.25c.25-.22-.06-.35-.39-.12l-7.18 4.52-3.09-.97c-.67-.21-.68-.67.14-.99l12.08-4.66c.56-.21 1.05.13.82 1.3z"/></svg>
                        –ù–∞–ø–∏—Å–∞—Ç—å —Ñ–ª–æ—Ä–∏—Å—Ç—É
                    </button>`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['—Ñ–æ—Ç–æ', '—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ', '—Ñ–æ—Ç–∫', '—Å–º—Å', '–æ—Ç—á–µ—Ç', '—Å–Ω–∏–º', '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏'],
                answer: () => {
                    const variants = [
                        `–ö–æ–Ω–µ—á–Ω–æ! üì∏ –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–µ–º —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ–≥–æ –±—É–∫–µ—Ç–∞ –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç–∞–≤–∫–æ–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∞–º –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –∏–ª–∏ –ø–æ —Å–º—Å. –í—ã –±—É–¥–µ—Ç–µ —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é –ø—Ä–∏–µ–¥–µ—Ç –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –≤—ã –∑–∞–∫–∞–∑–∞–ª–∏!`,
                        `–î–∞, –∫–æ–Ω–µ—á–Ω–æ! üì∏ –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –º—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π –±—É–∫–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤–∞–º ‚Äî –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –∏–ª–∏ —Å–º—Å. –¢–∞–∫ –≤—ã —Ç–æ—á–Ω–æ —É–≤–∏–¥–∏—Ç–µ, —á—Ç–æ –ø–æ–ª—É—á–∏—Ç –∞–¥—Ä–µ—Å–∞—Ç!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['—Å–∞–º–æ–≤—ã–≤–æ–∑', '–∑–∞–±–µ—Ä—É', '–ø—Ä–∏–µ–¥—É', '–∞–¥—Ä–µ—Å', '–≥–¥–µ –≤—ã', '–Ω–∞—Ö–æ–¥–∏–º—Å—è', '—Å–∞–ª–æ–Ω', '–º–∞–≥–∞–∑–∏–Ω', '–æ—Ñ–∏—Å', '—Ç–æ—á–∫–∞'],
                answer: () => {
                    const variants = [
                        `–ú—ã –≤ –¥–≤—É—Ö —Ç–æ—á–∫–∞—Ö! üìç<br>1. <b>–ë—É–ª—å–≤–∞—Ä –ú–µ—â–µ—Ä—Å–∫–∏–π 3–∫3</b> (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ! üåô)<br>2. <b>–ü—Ä-—Ç –ì–µ—Ä–æ–µ–≤ –î–æ–Ω–±–∞—Å—Å–∞, 6</b> (—Å 9 –¥–æ 21).<br><br>üî• –ö—Å—Ç–∞—Ç–∏, –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ <b>–°–ö–ò–î–ö–ê 600‚ÇΩ</b> –Ω–∞ –±—É–∫–µ—Ç—ã! –û—Ç–ª–æ–∂–∏—Ç—å —á—Ç–æ-—Ç–æ?`,
                        `–£ –Ω–∞—Å –¥–≤–∞ —Å–∞–ª–æ–Ω–∞: üìç<br>‚Ä¢ <b>–ë—É–ª—å–≤–∞—Ä –ú–µ—â–µ—Ä—Å–∫–∏–π 3–∫3</b> ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º 24/7 üåô<br>‚Ä¢ <b>–ü—Ä-—Ç –ì–µ—Ä–æ–µ–≤ –î–æ–Ω–±–∞—Å—Å–∞, 6</b> ‚Äî —Å 9:00 –¥–æ 21:00<br><br>üî• –ü—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ –¥–∞–µ–º <b>—Å–∫–∏–¥–∫—É 600‚ÇΩ</b>! –•–æ—Ç–∏—Ç–µ —á—Ç–æ-—Ç–æ –æ—Ç–ª–æ–∂–∏—Ç—å?`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–¥–æ—Å—Ç–∞–≤', '–ø—Ä–∏–≤–µ–∑—Ç–∏', '–¥–æ–º–æ–π', '–∫—É—Ä—å–µ—Ä', '–ø—Ä–∏–≤–µ–∑', '–¥–æ—Å—Ç–∞–≤—è—Ç'],
                answer: () => {
                    const variants = [
                        `–ü–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–π–æ–Ω–∞–º (–°–æ–≤–µ—Ç—Å–∫–∏–π, –°–æ—Ä–º–æ–≤–æ, –ê–≤—Ç–æ–∑–∞–≤–æ–¥, –õ–µ–Ω–∏–Ω—Å–∫–∏–π, –ú–æ—Å–∫–æ–≤—Å–∫–∏–π, –ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π, –ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π, –ü—Ä–∏–æ–∫—Å–∫–∏–π) –≤–µ–∑–µ–º <b>–ë–ï–°–ü–õ–ê–¢–ù–û</b>! üöÅ (—Å 8:00 –¥–æ 21:00).<br>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä—è–º–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞ —Å–∞–π—Ç–µ ‚Äî —ç—Ç–æ –∑–∞–π–º–µ—Ç 1 –º–∏–Ω—É—Ç—É!`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–π–æ–Ω–∞–º –≥–æ—Ä–æ–¥–∞ ‚Äî <b>–ë–ï–°–ü–õ–ê–¢–ù–û</b>! üöÅ<br>–†–∞–±–æ—Ç–∞–µ–º —Å 8:00 –¥–æ 21:00. –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –º–æ–∂–Ω–æ –ø—Ä—è–º–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞ —Å–∞–π—Ç–µ ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–¥–∑–µ—Ä–∂–∏–Ω—Å–∫', '–¥–∑–µ—Ä–∂–∏–Ω'], answer: () => {
                    const variants = [
                        `–í –î–∑–µ—Ä–∂–∏–Ω—Å–∫ –¥–æ—Å—Ç–∞–≤–∫–∞ —Å—Ç–æ–∏—Ç 1560 —Ä—É–±. üöó –£–¥–æ–±–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å–∞–π—Ç–µ, —á—Ç–æ–±—ã –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ä–∞–∑—É —É–≤–∏–¥–µ–ª –∑–∞—è–≤–∫—É!`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –î–∑–µ—Ä–∂–∏–Ω—Å–∫ ‚Äî 1560 —Ä—É–±. üöó –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ —Å–∞–π—Ç–µ, –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ä–∞–∑—É —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–±–æ—Ä', '–±–æ—Ä—Å–∫–∏–π'], answer: () => {
                    const variants = [
                        `–ù–∞ –ë–æ—Ä –¥–æ—Å—Ç–∞–≤–∫–∞ —Å—Ç–æ–∏—Ç 1000 —Ä—É–±. üöó –õ–µ–≥—á–µ –≤—Å–µ–≥–æ –æ—Ñ–æ—Ä–º–∏—Ç—å —á–µ—Ä–µ–∑ –∫–æ—Ä–∑–∏–Ω—É –Ω–∞ —Å–∞–π—Ç–µ.`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –ë–æ—Ä ‚Äî 1000 —Ä—É–±. üöó –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ —Å–∞–π—Ç–µ, —ç—Ç–æ –∑–∞–π–º–µ—Ç –º–∏–Ω—É—Ç—É!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–∫—Å—Ç–æ–≤–æ', '–∫—Å—Ç–æ–≤'], answer: () => {
                    const variants = [
                        `–í –ö—Å—Ç–æ–≤–æ –¥–æ—Å—Ç–∞–≤–∫–∞ —Å—Ç–æ–∏—Ç 1600 —Ä—É–±. üöó –ì–æ—Ç–æ–≤—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å–∞–π—Ç–µ?`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –ö—Å—Ç–æ–≤–æ ‚Äî 1600 —Ä—É–±. üöó –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ —Å–∞–π—Ç–µ, –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–±–∞–ª–∞—Ö–Ω–∞', '–±–∞–ª–∞—Ö–Ω'], answer: () => {
                    const variants = [
                        `–í –ë–∞–ª–∞—Ö–Ω—É –¥–æ—Å—Ç–∞–≤–∫–∞ —Å—Ç–æ–∏—Ç 1200 —Ä—É–±. üöó`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –ë–∞–ª–∞—Ö–Ω—É ‚Äî 1200 —Ä—É–±. üöó`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
             {
                keywords: ['–ø–∞–≤–ª–æ–≤–æ', '–ø–∞–≤–ª–æ–≤'], answer: () => {
                    const variants = [
                        `–í –ü–∞–≤–ª–æ–≤–æ –¥–æ—Å—Ç–∞–≤–∫–∞ 3600 —Ä—É–±. –î–∞–ª–µ–∫–æ–≤–∞—Ç–æ, –Ω–æ —Ü–≤–µ—Ç—ã –¥–æ–µ–¥—É—Ç —Å–≤–µ–∂–∏–º–∏! üå∏`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –ü–∞–≤–ª–æ–≤–æ ‚Äî 3600 —Ä—É–±. üöó –î–∞–ª–µ–∫–æ, –Ω–æ –º—ã –¥–æ—Å—Ç–∞–≤–∏–º —Ü–≤–µ—Ç—ã —Å–≤–µ–∂–∏–º–∏! üå∏`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
             {
                keywords: ['–∑–∞–≤–æ–ª–∂—å–µ', '–∑–∞–≤–æ–ª–∂'], answer: () => {
                    const variants = [
                        `–í –ó–∞–≤–æ–ª–∂—å–µ ‚Äî 3000 —Ä—É–±. üöó`,
                        `–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –ó–∞–≤–æ–ª–∂—å–µ ‚Äî 3000 —Ä—É–±. üöó`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–æ–±–ª–∞—Å—Ç', '–∑–∞ –≥–æ—Ä–æ–¥', '–¥–∞–ª–µ–∫–æ', '–ø—Ä–∏–≥–æ—Ä–æ–¥', '–æ–±–ª–∞—Å—Ç—å'],
                answer: () => {
                    const variants = [
                        `–ó–∞ –ø—Ä–µ–¥–µ–ª—ã –≥–æ—Ä–æ–¥–∞ —Å—á–∏—Ç–∞–µ–º 40 —Ä—É–±/–∫–º. –ù–∞–ø–∏—à–∏—Ç–µ —Ç–æ—á–Ω—ã–π –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç, —è –ø–æ–¥—Å–∫–∞–∂—É —Ü–µ–Ω—É! üëá`,
                        `–ó–∞ –≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∞ ‚Äî 40 —Ä—É–±/–∫–º. –£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å, –∏ —è –Ω–∞–∑–æ–≤—É —Å—Ç–æ–∏–º–æ—Å—Ç—å! üëá`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–æ–ø–ª–∞—Ç', '–∫–∞—Ä—Ç', '–Ω–∞–ª–∏—á–Ω', '–ø–ª–∞—Ç–µ–∂', '—Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å—Å—è', '–æ–ø–ª–∞—Ç–∏—Ç—å', '–¥–µ–Ω—å–≥–∏'],
                answer: () => {
                    const variants = [
                        `–ü—Ä–∏–Ω–∏–º–∞–µ–º –≤—Å—ë! üí≥ –ö–∞—Ä—Ç—ã (–ú–ò–†, Visa, MC), –ø–µ—Ä–µ–≤–æ–¥—ã, –Ω–∞–ª–∏—á–Ω—ã–µ –∫—É—Ä—å–µ—Ä—É (—Å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–æ–π).<br>–î–∞–∂–µ WesternUnion –∏ –ó–æ–ª–æ—Ç—É—é –ö–æ—Ä–æ–Ω—É –±–µ—Ä–µ–º. –ú–∞—Ñ–∏—è –º–æ–∂–µ—Ç –≤—Å—ë üòâ`,
                        `–û–ø–ª–∞—Ç–∞ –ª—é–±–∞—è! üí≥ –ö–∞—Ä—Ç—ã, –ø–µ—Ä–µ–≤–æ–¥—ã, –Ω–∞–ª–∏—á–Ω—ã–µ –∫—É—Ä—å–µ—Ä—É. WesternUnion –∏ –ó–æ–ª–æ—Ç—É—é –ö–æ—Ä–æ–Ω—É —Ç–æ–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º. –ú–∞—Ñ–∏—è –º–æ–∂–µ—Ç –≤—Å—ë üòâ`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–ø–µ—Å–Ω', '—Å—Ç–∏—Ö', '–≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏', '–º—É–∑—ã–∫', 'fmvibe', '–∞—É–¥–∏–æ', '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏'],
                answer: () => {
                    const variants = [
                        `–û, —ç—Ç–æ –Ω–∞—à–∞ —Ñ–∏—à–∫–∞! üé§ –ú–æ–∂–µ–º –∑–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é –∏–ª–∏ —Å—Ç–∏—Ö –∫ –±—É–∫–µ—Ç—É —á–µ—Ä–µ–∑ <a href="https://fmvibe.ru/" target="_blank" class="text-blue-500 underline">fmvibe.ru</a>. –≠—Ñ—Ñ–µ–∫—Ç "–í–∞—É" –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω! –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?`,
                        `–î–∞, —ç—Ç–æ –Ω–∞—à–∞ —Ñ–∏—à–∫–∞! üé§ –ó–∞–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Å–Ω–∏ –∏ —Å—Ç–∏—Ö–∏ –∫ –±—É–∫–µ—Ç—É —á–µ—Ä–µ–∑ <a href="https://fmvibe.ru/" target="_blank" class="text-blue-500 underline">fmvibe.ru</a>. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –æ—á–µ–Ω—å —Ç—Ä–æ–≥–∞—Ç–µ–ª—å–Ω–æ! –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ?`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['—Ç–µ–ª–µ—Ñ–æ–Ω', '–Ω–æ–º–µ—Ä', '—Å–≤—è–∑', '–∑–≤–æ–Ω', '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–∫–æ–Ω—Ç–∞–∫—Ç'],
                answer: () => {
                    const variants = [
                        `–ù–∞—à –Ω–æ–º–µ—Ä: <b>8 (953) 573-69-06</b> üìû<br>–ò–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π, –º–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É!`,
                        `–¢–µ–ª–µ—Ñ–æ–Ω: <b>8 (953) 573-69-06</b> üìû<br>–ú–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–π –Ω–æ–º–µ—Ä, –∏ –º—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤–∞–º!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['—Å–ø–∞—Å–∏–±–æ', '–±–ª–∞–≥–æ–¥–∞—Ä—é', '–±–ª–∞–≥–æ–¥–∞—Ä', '–ø–∞—Å–∏–±', '–º–µ—Ä—Å–∏'],
                answer: () => {
                    const variants = [
                        `–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! üåπ –ï—Å–ª–∏ —á—Ç–æ ‚Äî —è —Ç—É—Ç.`,
                        `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üåπ –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å, –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–≥—É!`,
                        `–†–∞–¥–∞ –ø–æ–º–æ—á—å! üåπ –ï—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            },
            {
                keywords: ['–ø–æ–∫–∞', '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', '–¥–æ –≤—Å—Ç—Ä–µ—á–∏', '—É–≤–∏–¥–∏–º—Å—è', '–≤—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ', '—É–¥–∞—á–∏'],
                answer: () => {
                    const variants = [
                        `–î–æ –≤—Å—Ç—Ä–µ—á–∏! üåπ –ñ–¥–µ–º –≤–∞—Å –≤ –Ω–∞—à–∏—Ö —Å–∞–ª–æ–Ω–∞—Ö!`,
                        `–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! üåπ –ë—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!`,
                        `–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ! üåπ –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å, –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–≥—É!`
                    ];
                    return variants[Math.floor(Math.random() * variants.length)];
                }
            }
        ];

        /* --- INITIALIZATION --- */
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            setGreeting();

            // Auto-open logic - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º welcome bubble –≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ –Ω–µ –∑–∞–∫—Ä—ã—Ç –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
            if (!sessionStorage.getItem('bubble_closed')) {
                setTimeout(() => { 
                    if (!isOpen) { 
                        els.welcome.classList.remove('hidden'); 
                        els.welcome.classList.add('pop-in'); 
                        playSound('in'); 
                    } 
                }, BUBBLE_DELAY);
                
                // –ê–≤—Ç–æ–æ—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                if (messages.length === 0) {
                    setTimeout(() => { 
                        if (!isOpen && !hasOpenedOnce) { 
                            toggleChat(true); 
                        } 
                    }, WELCOME_DELAY);
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
            if (messages.length > 0) {
                renderMessages();
                scrollToBottom();
            }
        });

        /* --- CORE LOGIC --- */
        function toggleChat(forceOpen = null) {
            if (forceOpen === true) isOpen = false;
            
            isOpen = !isOpen;
            hasOpenedOnce = true;
            vibrate();

            if (isOpen) {
                els.window.classList.remove('hidden');
                els.iconClosed.classList.add('hidden');
                els.iconOpened.classList.remove('hidden');
                els.welcome.classList.add('hidden');
                resetBadge();
                
                // Show Intro Screen if no name and no messages
                if (!userName && messages.length === 0) {
                    els.intro.classList.remove('hidden');
                    els.chatUI.classList.add('hidden');
                    setTimeout(() => els.usernameInput.focus(), 300);
                } else {
                    els.intro.classList.add('hidden');
                    els.chatUI.classList.remove('hidden');
                    setTimeout(() => els.input.focus(), 300);
                    scrollToBottom();
                }

            } else {
                els.window.classList.add('hidden');
                els.iconClosed.classList.remove('hidden');
                els.iconOpened.classList.add('hidden');
            }
        }

        /* --- NAME / INTRO LOGIC --- */
        function saveNameAndStart() {
            const name = els.usernameInput.value.trim();
            if (name) {
                userName = name;
                localStorage.setItem('chat_username', userName);
                els.intro.classList.add('hidden');
                els.chatUI.classList.remove('hidden');
                
                // Greeting message from bot
                const timeGreeting = getGreetingText();
                saveMessage(`${timeGreeting}, ${userName}! üëã<br>–Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–ª–æ—Ä–∏—Å—Ç. –ü–æ–¥—Å–∫–∞–∂—É –ø–æ —Ü–µ–Ω–∞–º, –¥–æ—Å—Ç–∞–≤–∫–µ –∏ –ø–æ–º–æ–≥—É —É–¥–∏–≤–∏—Ç—å! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞?`, 'in');
                
                setTimeout(() => els.input.focus(), 300);
            } else {
                els.usernameInput.classList.add('ring-2', 'ring-red-400');
                setTimeout(() => els.usernameInput.classList.remove('ring-2', 'ring-red-400'), 500);
            }
        }

        function skipName() {
            userName = '–ì–æ—Å—Ç—å';
            localStorage.setItem('chat_username', userName);
            els.intro.classList.add('hidden');
            els.chatUI.classList.remove('hidden');
            saveMessage(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! üëã<br>–Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–ª–æ—Ä–∏—Å—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`, 'in');
        }

        /* --- CHIPS SCROLL LOGIC --- */
        function scrollChips(direction) {
            const scrollAmount = 150;
            if (direction === 'left') {
                els.chips.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                els.chips.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        }

        /* --- SUGGEST WEBSITE ORDER --- */
        function suggestWebsite() {
            vibrate();
            setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
            showTyping();
            
            setTimeout(() => {
                removeTyping();
                setStatus('–≤ —Å–µ—Ç–∏');
                
                const siteMsg = `
                    <div class="font-bold mb-1">‚ö°Ô∏è –õ–µ–≥–∫–æ! –ó–∞–∫–∞–∂–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ</div>
                    –≠—Ç–æ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±. –í –∫–∞—Ç–∞–ª–æ–≥–µ –µ—Å—Ç—å –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±—É–∫–µ—Ç—ã.<br>
                    –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–π–º–µ—Ç –≤—Å–µ–≥–æ –º–∏–Ω—É—Ç—É, –∏ —Ñ–ª–æ—Ä–∏—Å—Ç—ã —Å—Ä–∞–∑—É –Ω–∞—á–Ω—É—Ç —Å–æ–±–∏—Ä–∞—Ç—å –∑–∞–∫–∞–∑! üëá
                    <br>
                    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'}); toggleChat();" class="w-full bg-[#2AABEE] text-white font-bold py-2.5 rounded-xl hover:bg-[#229ED9] transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
                    </button>
                    <div class="mt-3 text-xs text-center text-gray-400">
                        –°–ª–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å? <a href="#" onclick="callFlorist(); return false;" class="underline hover:text-gray-600">–ù–∞–ø–∏—Å–∞—Ç—å —Ñ–ª–æ—Ä–∏—Å—Ç—É</a>
                    </div>
                `;
                saveMessage(siteMsg, 'in');
                playSound('in');
            }, 800);
        }

        /* --- CALL SPECIALISTS LOGIC --- */
        
        // 1. FLORIST (For bouquet selection, custom orders)
        function callFlorist(reasonText) {
            vibrate();
            setStatus('–∑–æ–≤–µ—Ç —Ñ–ª–æ—Ä–∏—Å—Ç–∞...');
            showTyping();
            
            let contextMsg = "";
            if (contextMemory) {
                 contextMsg = `<div class="bg-blue-50 p-2 rounded text-xs text-gray-600 mb-2 border border-blue-100">üìù –Ø –ø–µ—Ä–µ–¥–∞–ª–∞ —Ñ–ª–æ—Ä–∏—Å—Ç—É: "${contextMemory}"</div>`;
            }
            
            setTimeout(() => {
                removeTyping();
                setStatus('–≤ —Å–µ—Ç–∏');
                
                const operatorMsg = `
                    <div class="font-bold mb-1">üå∑ –°–≤—è–∑—å —Å —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º</div>
                    ${reasonText || "–§–ª–æ—Ä–∏—Å—Ç —Å–µ–π—á–∞—Å —É –≤–∏—Ç—Ä–∏–Ω—ã –∏ –ø–æ–º–æ–∂–µ—Ç —Å –≤—ã–±–æ—Ä–æ–º. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ Telegram?"}
                    <br>
                    ${contextMsg}
                    <button onclick="openTelegramLink()" class="w-full bg-[#FF7EB3] text-white font-bold py-2.5 rounded-xl hover:bg-[#FF65A3] transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.56 8.35l-1.99 9.38c-.15.68-.56.84-1.13.52l-3.14-2.31-1.52 1.46c-.17.17-.31.31-.63.31l.22-3.19 5.81-5.25c.25-.22-.06-.35-.39-.12l-7.18 4.52-3.09-.97c-.67-.21-.68-.67.14-.99l12.08-4.66c.56-.21 1.05.13.82 1.3z"/></svg>
                        –ù–∞–ø–∏—Å–∞—Ç—å —Ñ–ª–æ—Ä–∏—Å—Ç—É
                    </button>
                `;
                saveMessage(operatorMsg, 'in');
                playSound('in');
            }, 800);
        }

        // 2. MANAGER (For logistics, FM orders, technical)
        function callManager(reasonText) {
            vibrate();
            setStatus('–∑–æ–≤–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞...');
            showTyping();
            
            let contextMsg = "";
            if (contextMemory) {
                 contextMsg = `<div class="bg-gray-100 p-2 rounded text-xs text-gray-600 mb-2 border border-gray-200">üìù –ó–∞–ø—Ä–æ—Å: "${contextMemory}"</div>`;
            }

            setTimeout(() => {
                removeTyping();
                setStatus('–≤ —Å–µ—Ç–∏');
                
                const operatorMsg = `
                    <div class="font-bold mb-1">üëî –°–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</div>
                    ${reasonText || "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –ª—É—á—à–µ –ø–∏—Å–∞—Ç—å —Å—é–¥–∞."}
                    <br>
                    ${contextMsg}
                    <button onclick="openTelegramLink()" class="w-full bg-[#2AABEE] text-white font-bold py-2.5 rounded-xl hover:bg-[#229ED9] transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.56 8.35l-1.99 9.38c-.15.68-.56.84-1.13.52l-3.14-2.31-1.52 1.46c-.17.17-.31.31-.63.31l.22-3.19 5.81-5.25c.25-.22-.06-.35-.39-.12l-7.18 4.52-3.09-.97c-.67-.21-.68-.67.14-.99l12.08-4.66c.56-.21 1.05.13.82 1.3z"/></svg>
                        –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
                    </button>
                `;
                saveMessage(operatorMsg, 'in');
                playSound('in');
            }, 800);
        }

        // 3. COMMERCE (B2B)
        function callCommerce(reasonText) {
             vibrate();
            setStatus('–∑–æ–≤–µ—Ç –æ—Ç–¥–µ–ª...');
            showTyping();

            setTimeout(() => {
                removeTyping();
                setStatus('–≤ —Å–µ—Ç–∏');
                
                const operatorMsg = `
                    <div class="font-bold mb-1">üíº –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª</div>
                    ${reasonText || "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ —ç—Ç–æ—Ç —á–∞—Ç."}
                    <br>
                    <button onclick="openTelegramLink()" class="w-full bg-gray-800 text-white font-bold py-2.5 rounded-xl hover:bg-black transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.56 8.35l-1.99 9.38c-.15.68-.56.84-1.13.52l-3.14-2.31-1.52 1.46c-.17.17-.31.31-.63.31l.22-3.19 5.81-5.25c.25-.22-.06-.35-.39-.12l-7.18 4.52-3.09-.97c-.67-.21-.68-.67.14-.99l12.08-4.66c.56-.21 1.05.13.82 1.3z"/></svg>
                        –û—Ç–¥–µ–ª –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
                    </button>
                `;
                saveMessage(operatorMsg, 'in');
                playSound('in');
            }, 800);
        }
        
        function handleManualOperatorCall() {
            // General fallback
            callManager("–ü–µ—Ä–µ–≤–æ–∂—É –≤–∞—Å –≤ Telegram –¥–ª—è —Å–≤—è–∑–∏.");
        }

        /* --- MESSAGING SYSTEM (THE BRAIN) --- */
        function sendChip(text) {
            vibrate();
            els.input.value = text;
            handleUserSend();
        }

        function handleUserSend() {
            const text = els.input.value.trim();
            if (!text) return;

            saveMessage(text, 'out');
            els.input.value = '';
            els.input.style.height = 'auto';
            playSound('out');

            // --- 0. CAPTURE CONTEXT ---
            // Try to find dates/times to pass to the operator
            const timeMatch = text.match(/(\d{1,2}[:.]\d{2})|–∑–∞–≤—Ç—Ä–∞|—Å–µ–≥–æ–¥–Ω—è|–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞/i);
            if (timeMatch) {
                contextMemory = text; // Remember the whole message if it contains time
            }

            const lowerText = text.toLowerCase();

            // --- 0. –ü–†–Ø–ú–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö (chips) - –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç! ---
            const chipResponses = {
                '—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –¥–æ—Å—Ç–∞–≤–∫–∞': () => `–ü–æ –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–∞–π–æ–Ω–∞–º (–°–æ–≤–µ—Ç—Å–∫–∏–π, –°–æ—Ä–º–æ–≤–æ, –ê–≤—Ç–æ–∑–∞–≤–æ–¥, –õ–µ–Ω–∏–Ω—Å–∫–∏–π, –ú–æ—Å–∫–æ–≤—Å–∫–∏–π, –ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π, –ö–∞–Ω–∞–≤–∏–Ω—Å–∫–∏–π, –ü—Ä–∏–æ–∫—Å–∫–∏–π) –≤–µ–∑–µ–º <b>–ë–ï–°–ü–õ–ê–¢–ù–û</b>! üöÅ (—Å 8:00 –¥–æ 21:00).<br>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –ø—Ä—è–º–æ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞ —Å–∞–π—Ç–µ ‚Äî —ç—Ç–æ –∑–∞–π–º–µ—Ç 1 –º–∏–Ω—É—Ç—É!`,
                '—Å–∫–∏–¥–∫–∞ –Ω–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑': () => `–ú—ã –≤ –¥–≤—É—Ö —Ç–æ—á–∫–∞—Ö! üìç<br>1. <b>–ë—É–ª—å–≤–∞—Ä –ú–µ—â–µ—Ä—Å–∫–∏–π 3–∫3</b> (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ! üåô)<br>2. <b>–ü—Ä-—Ç –ì–µ—Ä–æ–µ–≤ –î–æ–Ω–±–∞—Å—Å–∞, 6</b> (—Å 9 –¥–æ 21).<br><br>üî• –ö—Å—Ç–∞—Ç–∏, –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ <b>–°–ö–ò–î–ö–ê 600‚ÇΩ</b> –Ω–∞ –±—É–∫–µ—Ç—ã! –û—Ç–ª–æ–∂–∏—Ç—å —á—Ç–æ-—Ç–æ?`,
                '—Ü–µ–Ω—ã –Ω–∞ —Ü–≤–µ—Ç—ã': () => `–¶–µ–Ω—ã –Ω–∞ –±—É–∫–µ—Ç—ã —É –Ω–∞—Å —Ä–∞–∑–Ω—ã–µ –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–æ—Å—Ç–∞–≤–∞, —Ä–∞–∑–º–µ—Ä–∞ –∏ —Å–µ–∑–æ–Ω–∞! üíê<br>–ï—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç 1000‚ÇΩ –¥–æ –ø—Ä–µ–º–∏—É–º-–±—É–∫–µ—Ç–æ–≤. –¢–æ—á–Ω—É—é —Ü–µ–Ω—É –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏—Ç—å —É —Ñ–ª–æ—Ä–∏—Å—Ç–∞ –≤ —Å–∞–ª–æ–Ω–µ ‚Äî –æ–Ω –ø–æ–¥–±–µ—Ä–µ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç –∏ –ø–æ–≤–æ–¥.<br><br>–•–æ—Ç–∏—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º? –û–Ω –ø–æ–∫–∞–∂–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±—É–∫–µ—Ç—ã –∏ –Ω–∞–∑–æ–≤–µ—Ç —Ç–æ—á–Ω—ã–µ —Ü–µ–Ω—ã! üëá<br><button onclick="openTelegramLink()" class="w-full bg-[#FF7EB3] text-white font-bold py-2.5 rounded-xl hover:bg-[#FF65A3] transition flex items-center justify-center gap-2 transform active:scale-95 shadow-md mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.56 8.35l-1.99 9.38c-.15.68-.56.84-1.13.52l-3.14-2.31-1.52 1.46c-.17.17-.31.31-.63.31l.22-3.19 5.81-5.25c.25-.22-.06-.35-.39-.12l-7.18 4.52-3.09-.97c-.67-.21-.68-.67.14-.99l12.08-4.66c.56-.21 1.05.13.82 1.3z"/></svg>
                        –ù–∞–ø–∏—Å–∞—Ç—å —Ñ–ª–æ—Ä–∏—Å—Ç—É
                    </button>`,
                '–∑–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é/—Å—Ç–∏—Ö': () => `–û, —ç—Ç–æ –Ω–∞—à–∞ —Ñ–∏—à–∫–∞! üé§ –ú–æ–∂–µ–º –∑–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é –∏–ª–∏ —Å—Ç–∏—Ö –∫ –±—É–∫–µ—Ç—É —á–µ—Ä–µ–∑ <a href="https://fmvibe.ru/" target="_blank" class="text-blue-500 underline">fmvibe.ru</a>. –≠—Ñ—Ñ–µ–∫—Ç "–í–∞—É" –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω! –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?`,
                '–≥–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å': () => `–ú—ã –≤ –¥–≤—É—Ö —Ç–æ—á–∫–∞—Ö! üìç<br>1. <b>–ë—É–ª—å–≤–∞—Ä –ú–µ—â–µ—Ä—Å–∫–∏–π 3–∫3</b> (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ! üåô)<br>2. <b>–ü—Ä-—Ç –ì–µ—Ä–æ–µ–≤ –î–æ–Ω–±–∞—Å—Å–∞, 6</b> (—Å 9 –¥–æ 21).<br><br>üî• –ö—Å—Ç–∞—Ç–∏, –ø—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ <b>–°–ö–ò–î–ö–ê 600‚ÇΩ</b> –Ω–∞ –±—É–∫–µ—Ç—ã! –û—Ç–ª–æ–∂–∏—Ç—å —á—Ç–æ-—Ç–æ?`
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –∫–Ω–æ–ø–æ–∫ (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ —ç–º–æ–¥–∑–∏)
            for (let [chipText, responseFn] of Object.entries(chipResponses)) {
                const normalizedChip = chipText.toLowerCase().replace(/[^\w\s]/g, '');
                const normalizedInput = lowerText.replace(/[^\w\s]/g, '');
                
                if (normalizedInput.includes(normalizedChip) || normalizedChip.split(' ').every(word => normalizedInput.includes(word))) {
                    setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
                    showTyping();
                    setTimeout(() => {
                        removeTyping();
                        setStatus('–≤ —Å–µ—Ç–∏');
                        const answer = responseFn();
                        saveMessage(answer, 'in');
                        playSound('in');
                        lastBotResponse = answer; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏
                    }, 800);
                    return; // –í—ã—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–ª—å—à–µ
                }
            }

            // --- 1. –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–º–∏!) ---
            const greetings = ['–∑–¥—Ä–∞–≤—Å—Ç–≤', '–ø—Ä–∏–≤–µ—Ç', '–¥–æ–±—Ä—ã–π –¥–µ–Ω—å', '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ', '–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä', '–¥–æ–±—Ä–æ–π –Ω–æ—á–∏', '–¥–æ–±—Ä–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏', 'hi', 'hello', 'hey', '–¥–æ–±—Ä'];
            if (greetings.some(g => lowerText.includes(g)) && (lowerText.length < 30 || lowerText.match(/^[^\?\!\.]*[^\?\!\.]{0,20}$/))) {
                setTimeout(() => {
                    setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
                    showTyping();
                    setTimeout(() => {
                        removeTyping();
                        setStatus('–≤ —Å–µ—Ç–∏');
                        const greeting = getGreetingText();
                        const variants = [
                            `${greeting}! üëã<br>–Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–ª–æ—Ä–∏—Å—Ç –∏–∑ –¶–≤–µ—Ç–æ—á–Ω–æ–π –ú–∞—Ñ–∏–∏. –†–∞–¥–∞ –ø–æ–º–æ—á—å!<br><br>–ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞?<br>‚Ä¢ üí∏ –£–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã –Ω–∞ –±—É–∫–µ—Ç—ã<br>‚Ä¢ üöö –£—Ç–æ—á–Ω–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É<br>‚Ä¢ üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑ —Å–æ —Å–∫–∏–¥–∫–æ–π<br>‚Ä¢ üìç –ê–¥—Ä–µ—Å–∞ –Ω–∞—à–∏—Ö —Å–∞–ª–æ–Ω–æ–≤<br>‚Ä¢ üéµ –ó–∞–∫–∞–∑–∞—Ç—å –ø–µ—Å–Ω—é/—Å—Ç–∏—Ö –∫ –±—É–∫–µ—Ç—É<br><br>–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç! üòä`,
                            `${greeting}! üëã<br>–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —è —Ñ–ª–æ—Ä–∏—Å—Ç –∏–∑ –¶–≤–µ—Ç–æ—á–Ω–æ–π –ú–∞—Ñ–∏–∏. –ì–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å —Å –≤—ã–±–æ—Ä–æ–º –±—É–∫–µ—Ç–∞!<br><br>–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?<br>‚Ä¢ üí∏ –¶–µ–Ω—ã –Ω–∞ –±—É–∫–µ—Ç—ã<br>‚Ä¢ üöö –î–æ—Å—Ç–∞–≤–∫–∞<br>‚Ä¢ üèÉ –°–∞–º–æ–≤—ã–≤–æ–∑ (—Å–∫–∏–¥–∫–∞ 600‚ÇΩ)<br>‚Ä¢ üìç –ì–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è<br>‚Ä¢ üéµ –ü–µ—Å–Ω–∏ –∏ —Å—Ç–∏—Ö–∏ –∫ –±—É–∫–µ—Ç—É<br><br>–ü–∏—à–∏—Ç–µ, –æ—Ç–≤–µ—á—É –±—ã—Å—Ç—Ä–æ! üòä`
                        ];
                        const greetingMsg = variants[Math.floor(Math.random() * variants.length)];
                        saveMessage(greetingMsg, 'in');
                        playSound('in');
                    }, 800);
                }, 500);
                return;
            }

            // --- 2. AUDIO / SONGS (Direct Request) ---
            if (lowerText.includes('–ø–µ—Å–Ω') || lowerText.includes('—Å—Ç–∏—Ö') || lowerText.includes('–º—É–∑—ã–∫') || lowerText.includes('–∞—É–¥–∏–æ') || lowerText.includes('fmvibe')) {
                 setTimeout(() => {
                    setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
                    showTyping();
                    setTimeout(() => {
                        removeTyping();
                        setStatus('–≤ —Å–µ—Ç–∏');
                        const answer = `–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ñ—É—Ä–æ—Ä? üé§üî•<br>–ó–∞–∫–∞–∂–∏—Ç–µ <b>–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø–µ—Å–Ω—é</b> –∏–ª–∏ <b>–º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</b> –≤ –Ω–∞—à–µ–º –∞—É–¥–∏–æ-–ø—Ä–æ–¥–∞–∫—à–Ω–µ!<br>–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç–∫–∞, –∞ –Ω–∞—Å—Ç–æ—è—â–∞—è —ç–º–æ—Ü–∏—è. –ò–¥–µ–∞–ª—å–Ω–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –±—É–∫–µ—Ç—É. üåπüé∂<br><br>–°–ª—É—à–∞–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –∑–∞–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç—É—Ç: <a href="https://fmvibe.ru/" target="_blank" class="text-blue-500 font-bold underline">fmvibe.ru</a>`;
                        saveMessage(answer, 'in');
                        playSound('in');
                    }, 1000);
                }, 500);
                return;
            }

            // --- 3. POSTCARDS (Free + Upsell) ---
            if (lowerText.includes('–æ—Ç–∫—Ä—ã—Ç–∫') || lowerText.includes('–∑–∞–ø–∏—Å–∫') || lowerText.includes('–ø–æ–¥–ø–∏—Å') || lowerText.includes('—Ç–µ–∫—Å—Ç') || lowerText.includes('–ø–æ–∂–µ–ª–∞–Ω–∏') || lowerText.includes('—Å–ª–æ–≤–∞')) {
                 setTimeout(() => {
                    setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
                    showTyping();
                    setTimeout(() => {
                        removeTyping();
                        setStatus('–≤ —Å–µ—Ç–∏');
                        const answer = `–ú–∏–Ω–∏-–æ—Ç–∫—Ä—ã—Ç–∫–∞ —Å –≤–∞—à–∏–º–∏ —Ç–µ–ø–ª—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ ‚Äî <b>–±–µ—Å–ø–ª–∞—Ç–Ω–æ</b> –∫ –∫–∞–∂–¥–æ–º—É –±—É–∫–µ—Ç—É! üíå –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.<br><br>üí° <b>–ò–¥–µ—è:</b> –•–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–º? –î–æ–±–∞–≤—å—Ç–µ –∫ –±—É–∫–µ—Ç—É <b>–∞—É–¥–∏–æ-–æ—Ç–∫—Ä—ã—Ç–∫—É</b> –∏–ª–∏ –ø–µ—Å–Ω—é!<br><br><a href="https://fmvibe.ru/" target="_blank" class="text-blue-500 underline">–ü–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ fmvibe.ru</a>`;
                        saveMessage(answer, 'in');
                        playSound('in');
                    }, 1000);
                }, 500);
                return;
            }

            // --- 4. HELP / CONFUSION ---
            if (lowerText.includes('—á—Ç–æ –¥–µ–ª–∞—Ç—å') || lowerText.includes('–∫–∞–∫ –±—ã—Ç—å') || lowerText.includes('–Ω–µ –ø–æ–Ω–∏–º–∞—é') || lowerText.includes('–ø–æ–º–æ–≥–∏') || lowerText.includes('–∏–Ω—Å—Ç—Ä—É–∫—Ü')) {
                 setTimeout(() => {
                    setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
                    showTyping();
                    setTimeout(() => {
                         removeTyping();
                         setStatus('–≤ —Å–µ—Ç–∏');
                         // Show split choice
                         const helpMsg = `
                            –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è! ü§ù<br>
                            üîπ <b>–•–æ—Ç–∏—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å —Ü–≤–µ—Ç—ã?</b><br>
                            –≠—Ç–æ –ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞ —Å–∞–π—Ç–µ.<br>
                            <a href="#" onclick="window.scrollTo({top: 0, behavior: 'smooth'}); toggleChat(); return false;" class="text-blue-500 font-bold underline">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
                            <br>
                            üîπ <b>–ï—Å—Ç—å —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å?</b><br>
                            –ù–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Telegram, –æ–Ω –ø–æ–º–æ–∂–µ—Ç.
                            <button onclick="openTelegramLink()" class="mt-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 rounded-lg transition text-xs flex items-center justify-center gap-1">
                                –ù–∞–ø–∏—Å–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
                            </button>
                        `;
                        saveMessage(helpMsg, 'in');
                        playSound('in');
                    }, 1000);
                }, 500);
                return;
            }

            // --- 4. ORDER STATUS (Logistics -> MANAGER) ---
            if (lowerText.includes('fm') || lowerText.includes('—Ñ–º') || lowerText.includes('–≥–¥–µ –∑–∞–∫–∞–∑') || lowerText.includes('—Å—Ç–∞—Ç—É—Å') || lowerText.includes('—Ç—Ä–µ–∫') || lowerText.includes('–∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∞–≤—è—Ç')) {
                 const variants = [
                     "–í–æ–ø—Ä–æ—Å—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É –∑–∞–∫–∞–∑–∞ —Ä–µ—à–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ª–æ–≥–∏—Å—Ç–∏–∫–µ. –ü–µ—Ä–µ–∫–ª—é—á–∞—é!",
                     "–ü–æ —Å—Ç–∞—Ç—É—Å—É –∑–∞–∫–∞–∑–∞ –ª—É—á—à–µ —Å–ø—Ä–æ—Å–∏—Ç—å —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –æ–Ω –∑–Ω–∞–µ—Ç –≤—Å–µ –¥–µ—Ç–∞–ª–∏. –°–æ–µ–¥–∏–Ω—è—é!"
                 ];
                 callManager(variants[Math.floor(Math.random() * variants.length)]);
                 return;
            }

            // --- 5. COMMERCIAL (Partners -> COMMERCE) ---
            if (lowerText.includes('—Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤') || lowerText.includes('–∫–æ–º–º–µ—Ä—á') || lowerText.includes('–æ–ø—Ç') || lowerText.includes('—Ä–µ–∫–ª–∞–º') || lowerText.includes('–ø–æ—Å—Ç–∞–≤')) {
                const variants = [
                    "–í–æ–ø—Ä–æ—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª.",
                    "–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –ª—É—á—à–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª. –ü–µ—Ä–µ–∫–ª—é—á–∞—é!"
                ];
                callCommerce(variants[Math.floor(Math.random() * variants.length)]);
                return;
            }
            
            // --- 6. INTERNATIONAL / NO CALL ---
            if (lowerText.includes('–Ω–µ –≤ —Ä–æ—Å—Å–∏–∏') || lowerText.includes('–∑–∞–≥—Ä–∞–Ω–∏—Ü') || lowerText.includes('–±–µ–∑ –∑–≤–æ–Ω–∫–∞') || lowerText.includes('–Ω–µ –∑–≤–æ–Ω')) {
                setTimeout(() => {
                    setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
                    showTyping();
                    setTimeout(() => {
                        removeTyping();
                        setStatus('–≤ —Å–µ—Ç–∏');
                        saveMessage(`–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º! üôå<br>–ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ <b>Western Union, MoneyGram</b> –∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã.<br>–ó–≤–æ–Ω–∏—Ç—å –Ω–µ –±—É–¥–µ–º, –≤—Å–µ –æ–±—Å—É–¥–∏–º –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ.`, 'in');
                        callManager("–ù–∞–ø–∏—à–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤."); 
                    }, 1200);
                }, 500);
                return;
            }

            // --- 7. WEBSITE SALES PUSH (Very Specific now) ---
            // removed "—Ö–æ—á—É", "–¥–∞–≤–∞–π", "—Å–æ–≥–ª–∞—Å–µ–Ω" from global triggers to avoid false positives
            const explicitSalesTriggers = ['–æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑', '–∑–∞–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ', '–∑–∞–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É', '–æ—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É', '–∑–∞–∫–∞–∑–∞—Ç—å –±—É–∫–µ—Ç'];
            
            if (explicitSalesTriggers.some(w => lowerText.includes(w))) {
                suggestWebsite();
                return;
            }

            // --- 8. FLOWER SPECIFICS (Choice -> FLORIST) ---
            if (lowerText.includes('–ø–æ—Å–æ–≤–µ—Ç—É–π') || lowerText.includes('–≤—ã–±—Ä–∞—Ç—å') || lowerText.includes('–∫–∞–∫–∏–µ –µ—Å—Ç—å') || lowerText.includes('—Å–≤–µ–∂') || lowerText.includes('—Ñ–ª–æ—Ä–∏—Å—Ç') || lowerText.includes('—Ä–æ–∑—ã') || lowerText.includes('–ø–∏–æ–Ω—ã') || lowerText.includes('—Ç—é–ª—å–ø–∞–Ω') || lowerText.includes('—Ö—Ä–∏–∑–∞–Ω—Ç–µ–º') || lowerText.includes('–ª–∏–ª–∏')) {
                const variants = [
                    "–§–ª–æ—Ä–∏—Å—Ç —Å–µ–π—á–∞—Å –≤ —Å–∞–ª–æ–Ω–µ –∏ –ø—Ä–∏—à–ª–µ—Ç —Ñ–æ—Ç–æ —Å–≤–µ–∂–∏—Ö —Ü–≤–µ—Ç–æ–≤.",
                    "–§–ª–æ—Ä–∏—Å—Ç —Å–µ–π—á–∞—Å —É –≤–∏—Ç—Ä–∏–Ω—ã, –ø–æ–∫–∞–∂–µ—Ç —Å–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã –∏ –ø–æ–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –±—É–∫–µ—Ç.",
                    "–°–æ–µ–¥–∏–Ω—è—é —Å —Ñ–ª–æ—Ä–∏—Å—Ç–æ–º ‚Äî –æ–Ω –ø–æ–∫–∞–∂–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±—É–∫–µ—Ç—ã –∏ –ø–æ–º–æ–∂–µ—Ç —Å –≤—ã–±–æ—Ä–æ–º!"
                ];
                callFlorist(variants[Math.floor(Math.random() * variants.length)]);
                return;
            }

            // --- 9. GENERAL OPERATOR ---
            if (lowerText.includes('–æ–ø–µ—Ä–∞—Ç–æ—Ä') || lowerText.includes('—á–µ–ª–æ–≤–µ–∫') || lowerText.includes('–º–µ–Ω–µ–¥–∂–µ—Ä') || lowerText.includes('–∂–∏–≤–æ–π') || lowerText.includes('—Ä–µ–∞–ª—å–Ω—ã–π')) {
                const variants = [
                    "–ö–æ–Ω–µ—á–Ω–æ! –°–æ–µ–¥–∏–Ω—è—é —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º ‚Äî –æ–Ω –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.",
                    "–ü–µ—Ä–µ–∫–ª—é—á–∞—é –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!"
                ];
                callManager(variants[Math.floor(Math.random() * variants.length)]);
                return;
            }

            setStatus('–ø–µ—á–∞—Ç–∞–µ—Ç...');
            showTyping();
            
            // --- 10. FALLBACK KNOWLEDGE BASE ---
            setTimeout(() => {
                removeTyping();
                setStatus('–≤ —Å–µ—Ç–∏');
                
                let foundAnswer = null;
                
                for (let entry of knowledgeBase) {
                    if (entry.keywords.some(k => lowerText.includes(k))) {
                        foundAnswer = entry.answer();
                        break;
                    }
                }

                // –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞—Ç—å
                // if (foundAnswer && foundAnswer === lastBotResponse) {
                //      callManager("–ö–∞–∂–µ—Ç—Å—è, —è —Ö–æ–∂—É –ø–æ –∫—Ä—É–≥—É. –î–∞–≤–∞–π—Ç–µ –ø–æ–∑–æ–≤–µ–º —á–µ–ª–æ–≤–µ–∫–∞!");
                //      return;
                // }

                if (!foundAnswer) {
                     // Check context if question is short
                     if(text.length < 20 && (text.includes('?'))) {
                         const variants = [
                             "–•–º, –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏. –ü–µ—Ä–µ–≤–æ–∂—É –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –æ–Ω —Ç–æ—á–Ω–æ –ø–æ–º–æ–∂–µ—Ç!",
                             "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è. –°–æ–µ–¥–∏–Ω—è—é —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º ‚Äî –æ–Ω —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è!"
                         ];
                         callManager(variants[Math.floor(Math.random() * variants.length)]);
                     } else {
                         const variants = [
                             "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª –æ—Ç–≤–µ—Ç–∞ –≤ —Å–≤–æ–µ–π –±–∞–∑–µ. –ù–æ –º–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç! –°–æ–µ–¥–∏–Ω–∏—Ç—å?",
                             "–•–º, —è –Ω–µ —É–≤–µ—Ä–µ–Ω–∞ –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ. –î–∞–≤–∞–π—Ç–µ —Å–ø—Ä–æ—Å–∏–º —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Äî –æ–Ω —Ç–æ—á–Ω–æ –ø–æ–º–æ–∂–µ—Ç!",
                             "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –ª—É—á—à–µ –∑–∞–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É ‚Äî –æ–Ω –∑–Ω–∞–µ—Ç –≤—Å–µ –¥–µ—Ç–∞–ª–∏. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å?"
                         ];
                         callManager(variants[Math.floor(Math.random() * variants.length)]);
                     }
                     return;
                }

                saveMessage(foundAnswer, 'in');
                playSound('in');
                vibrate();
                if(!isOpen) incrementBadge(); 

            }, 800 + Math.random() * 800); 
        }

        function saveMessage(text, dir, image = null) {
            if(dir === 'in') lastBotResponse = text;

            const msg = {
                text: text,
                type: dir,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                image: image
            };
            messages.push(msg);
            localStorage.setItem('chat_history', JSON.stringify(messages));
            renderOneMessage(msg);
            scrollToBottom();
        }

        function renderMessages() {
            els.area.innerHTML = '';
            els.area.innerHTML += `
                <div class="flex justify-center my-2 opacity-80">
                    <span class="bg-black/20 text-white text-[11px] px-2 py-0.5 rounded-full font-medium shadow-sm backdrop-blur-sm">–°–µ–≥–æ–¥–Ω—è</span>
                </div>
            `;
            messages.forEach(msg => renderOneMessage(msg));
        }

        function renderOneMessage(msg) {
            const isOut = msg.type === 'out';
            const msgDiv = document.createElement('div');
            // Changed leading-snug to leading-relaxed for better spacing
            msgDiv.className = `flex flex-col ${isOut ? 'items-end max-w-[85%] self-end message-out' : 'items-start max-w-[85%] self-start message-in'} relative group pop-in`;
            
            const bubbleClass = isOut ? 'bg-[#EEFFDE] text-gray-900' : 'bg-white text-gray-900';
            const checkIcon = isOut ? '<span class="text-[#2AABEE] text-xs font-bold ml-1">‚úì‚úì</span>' : '';

            let imageHtml = '';
            if (msg.image) {
                imageHtml = `
                    <div class="mb-1 rounded-lg overflow-hidden relative cursor-pointer group/img" onclick="openTelegramLink()">
                        <img src="${msg.image}" class="w-full h-auto object-cover max-h-[160px] group-hover/img:opacity-90 transition">
                    </div>
                `;
            }

            // Simple HTML support
            let content = msg.text;
            if(!content.includes('<div') && !content.includes('<button')) {
                 content = content.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                <div class="${bubbleClass} p-2 md:p-2.5 rounded-lg md:rounded-xl ${isOut ? 'rounded-br-none' : 'rounded-bl-none'} shadow-[0_1px_2px_rgba(0,0,0,0.1)] text-[14px] md:text-[15px] leading-relaxed min-w-[60px]">
                    ${isOut ? '' : '<div class="text-[#2AABEE] text-[11px] md:text-[12px] font-bold mb-0.5 md:mb-1 leading-none">–§–ª–æ—Ä–∏—Å—Ç –ê–Ω–Ω–∞</div>'}
                    ${imageHtml}
                    ${content}
                    <div class="flex justify-end items-end gap-1 mt-0.5 md:mt-1 select-none leading-none opacity-60">
                        <span class="text-[9px] md:text-[10px] ${isOut ? 'text-[#539634]' : 'text-gray-400'}">${msg.time}</span>
                        ${checkIcon}
                    </div>
                </div>
            `;
            els.area.appendChild(msgDiv);
        }

        /* --- UTILS --- */
        function getGreetingText() {
            const hour = new Date().getHours();
            if (hour < 6) return '–î–æ–±—Ä–æ–π –Ω–æ—á–∏';
            if (hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
            if (hour < 18) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
            return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
        }

        function setGreeting() {
            const greeting = getGreetingText();
            els.bubbleText.innerHTML = `${greeting}! üëã<br>–°–¥–µ–ª–∞–µ–º —Å–∫–∏–¥–∫—É –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑?`;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex flex-col items-start max-w-[85%] self-start relative message-in pop-in';
            typingDiv.innerHTML = `
                <div class="bg-white px-2.5 md:px-3 py-2 md:py-2.5 rounded-lg md:rounded-xl rounded-bl-none shadow-sm flex gap-1 items-center h-[32px] md:h-[36px]">
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            els.area.appendChild(typingDiv);
            scrollToBottom();
        }

        function removeTyping() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        function setStatus(text) {
            els.status.innerText = text;
            if(text === '–ø–µ—á–∞—Ç–∞–µ—Ç...' || text.includes('–∑–æ–≤–µ—Ç')) els.status.classList.add('animate-pulse');
            else els.status.classList.remove('animate-pulse');
        }

        function vibrate() { if (navigator.vibrate) navigator.vibrate(10); }
        function playSound(type) { try { const audio = type === 'out' ? els.audioOut : els.audioIn; audio.currentTime = 0; audio.play().catch(e => {}); } catch(e){} }
        function scrollToBottom() { els.area.scrollTop = els.area.scrollHeight; }
        function loadHistory() { const saved = localStorage.getItem('chat_history'); if (saved) messages = JSON.parse(saved); }
        function openTelegramLink() { window.open(`https://t.me/${TELEGRAM_USERNAME}`, '_blank'); }
        function closeWelcome(e) { 
            if(e) e.stopPropagation(); 
            els.welcome.classList.add('hidden'); 
            sessionStorage.setItem('bubble_closed', 'true'); 
            console.log('Welcome bubble –∑–∞–∫—Ä—ã—Ç');
        }
        function incrementBadge() { unreadCount++; els.badgeCount.innerText = unreadCount; els.badge.classList.remove('hidden'); }
        function resetBadge() { unreadCount = 0; els.badge.classList.add('hidden'); }

        els.input.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        els.input.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserSend(); } });
        els.usernameInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { saveNameAndStart(); } });

    </script>
</body>
</html>

